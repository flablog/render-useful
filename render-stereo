#!/bin/bash
#+
# This script invokes Blender to render the specified .blend file.
# It renders two images, offsetting the camera along its local X axis,
# and combines them to produce a stereo pair. Besides Blender, it also
# needs the Python-Cairo graphics library. Invoke it as follows:
#
#     render-stereo [options...] blendfile
#
# where the options are
#    --blender=blender
#          specifies the path to the Blender executable. Defaults to
#          searching for the name “blender” in your PATH.
#    --camera=camera
#          specifies the name of the camera to use. If omitted,
#          defaults to the active camera for the scene.
#    --offset=offset
#          specifies the distance in BU to offset the camera to each
#          side from its initial position to generate the image for
#          each eye; if omitted, defaults to 0.1.
#    --percent=percent
#          specifies the percentage of the render size at which to
#          generate the images; if omitted, defaults to the last-saved
#          setting in the blendfile.
#    --scene=scene
#          specifies the scene to render. If omitted, defaults to
#          the active scene.
#
# The output will be 3 PNG files in the current directory; if
# blendfile is “basename.blend”, then the output files will be named
# “basename L.png”, “basename R.png” (being the separate left- and
# right-eye images respectively) and “basename Stereo.png” (being the
# first two images combined side-by-side).
#
# Written by Lawrence D'Oliveiro <ldo@geek-central.gen.nz>.
#-

blender=blender
camera=
scene=
stereo_offset=0.1
render_percentage=
crossed=
for ((;;)); do
    if [ "${1:0:2}" != "--" ]; then
        break
    fi
    opt="${1:2:${#1}}"
    shift
    val="${opt#*=}"
    opt="${opt%%=*}"
    if [ "$opt" = "blender" ]; then
        blender="$val"
    elif [ "$opt" = "camera" ]; then
        camera="$val"
    elif [ "$opt" = "crossed" ]; then
        crossed=1
    elif [ "$opt" = "offset" ]; then
        stereo_offset="$val"
    elif [ "$opt" = "percent" ]; then
        render_percentage="$val"
    elif [ "$opt" = "scene" ]; then
        scene="$val"
    else
        echo "bad option $opt" 1>&2
        exit 3
    fi
done

if [ $# != 1 ]; then
    echo $'Usage:\n\t'"$0" $'<blendfile>\n' 1>&2
    exit 3
fi
blendfile="$1"
# pass parameters to Python script in environment variables to avoid
# problems with special characters
export RENDER_stereo_offset="$stereo_offset"
RENDER_image_name="${blendfile##*/}"
RENDER_image_name="${RENDER_image_name%.*}"
export RENDER_image_name
export RENDER_scene="$scene"
export RENDER_camera="$camera"
export RENDER_percentage="$render_percentage"
export RENDER_crossed="$crossed"

"$blender" -b "$blendfile" -P <(cat <<'EOD'
import sys
import os
import bpy
from mathutils import \
    Matrix, \
    Vector
import cairo

image_basename = os.getenv("RENDER_image_name")
stereo_offset = float(os.getenv("RENDER_stereo_offset"))
render_percentage = os.getenv("RENDER_percentage", "")
if render_percentage != "" :
    render_percentage = int(render_percentage)
else :
    render_percentage = None
#end if
scene_name = os.getenv("RENDER_scene", "")
if scene_name == "" :
    scene_name = None
#end if
camera_name = os.getenv("RENDER_camera", "")
if camera_name == "" :
    camera_name = None
#end if
crossed = os.getenv("RENDER_crossed", "") != ""

left_eye_name = image_basename + " L.png"
right_eye_name = image_basename + " R.png"
stereo_name = image_basename + " Stereo.png"

if scene_name != None :
    bpy.context.screen.scene = bpy.data.scenes[scene_name]
#end if
if camera_name != None :
    bpy.context.scene.camera = bpy.data.objects[camera_name]
#end if
active_scene = bpy.context.scene
active_camera = active_scene.camera
orig_camera_matrix = active_camera.matrix_local

sys.stdout.write("active scene is “%s”, camera is “%s”\n" % (active_scene.name, active_camera.name))
if render_percentage != None :
    active_scene.render.resolution_percentage = render_percentage
#end if
sys.stdout.write("render resolution is %d%% * (%d, %d)\n" % (active_scene.render.resolution_percentage, active_scene.render.resolution_x, active_scene.render.resolution_y))

active_camera.matrix_local = orig_camera_matrix * Matrix.Translation(Vector((- stereo_offset, 0, 0))) # left eye
active_scene.render.filepath = left_eye_name
bpy.ops.render.render \
  (
    write_still = True
  )
active_camera.matrix_local = orig_camera_matrix * Matrix.Translation(Vector((stereo_offset, 0, 0))) # right eye
active_scene.render.filepath = right_eye_name
bpy.ops.render.render \
  (
    write_still = True
  )

left_eye = cairo.ImageSurface.create_from_png(left_eye_name)
right_eye = cairo.ImageSurface.create_from_png(right_eye_name)
if crossed :
    left_eye, right_eye = right_eye, left_eye
#end if
eye_offset = left_eye.get_width()
image_height = left_eye.get_height()
stereo = cairo.ImageSurface(cairo.FORMAT_RGB24, eye_offset * 2, image_height)
compose = cairo.Context(stereo)
compose.set_operator(cairo.OPERATOR_SOURCE)
compose.set_source_rgba(0, 0, 0, 0)
compose.paint()
compose.set_source_surface(right_eye, 0, 0)
compose.rectangle(0, 0, eye_offset, image_height)
compose.fill()
compose.set_source_surface(left_eye, eye_offset, 0)
compose.rectangle(eye_offset, 0, eye_offset, image_height)
compose.fill()
stereo.flush()
stereo.write_to_png(stereo_name)
sys.stdout.write("Saved %s\n" % stereo_name)
EOD
)
